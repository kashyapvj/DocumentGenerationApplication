@using DocumentGenerationApplication.Models.Tables
@model DocumentGenerationApplication.Models.UI_Model.SalaryBreakdownInput

@{
    ViewData["Title"] = "CalculateSalaryBreakdown";
    Layout = "_Layout";
    var today = DateTime.Today.ToString("yyyy-MM-dd");

}



<html>
    <head>
    <link href="../lib/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet" />

    <style>
        body {
            /*background-color: #F6F2FD /* Or #D3D3D3 for the exact light grey hex code */
            background-color: #E3E3E3 /* Or #D3D3D3 for the exact light grey hex code */
        }

    </style>
    </head>
    <body id="Body">


    <!-- all your sections: Employee Details, Job Info, Address, Dates, Preferences, Salary -->
    <form id="salaryForm" asp-controller="Salary" asp-action="CalculateSalaryBreakdown" method="post" class="container mt-4 shadow p-4 rounded bg-light">
        <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

        <!-- Section: Document Type -->
        <div class="card mb-4">
            <div class="card-header text-white" style="background-color: #7066E0;color:white">
                <h6 class="mb-0">Document Details</h6>
            </div>
            <div class="card-body row g-3">
                <div class="col-md-4">
                    <label asp-for="DocumentType" class="form-label fw-bold">Document Type</label>
                    <select asp-for="DocumentType" class="form-select" id="documentType" required>
                        <option value="">-- Select Document Type --</option>
                        <option value="1">Offer Letter Experienced</option>
                        <option value="2">Offer Letter Fresher</option>
                        <option value="3">Appointment Letter Experienced</option>
                        <option value="4">Appointment Letter Fresher</option>
                    </select>
                    <span asp-validation-for="DocumentType" class="text-danger"></span>
                </div>
            </div>
        </div>


        <!-- Section: Form Fields Container -->
        <div id="formFieldsContainer">
            <!-- Section: Employee Details -->
            <div class="card mb-4">
                <div class="card-header text-white" style="background-color: #7066E0;color:white">
                    <h6 class="mb-0">Employee Details</h6>
                </div>
                <div class="card-body row g-3">
                    <div class="col-md-3">
                        <label for="EmployeeId" class="form-label fw-bold">Employee Id</label>
                        <input id="EmployeeId" name="EmployeeId" class="form-control" required />
                    </div>
                    <div class="col-md-3">
                        <label asp-for="EmployeeName" class="form-label fw-bold"></label>
                        <input id="EmployeeName" asp-for="EmployeeName" class="form-control" />
                        <span asp-validation-for="EmployeeName" class="text-danger"></span>
                    </div>
                    <div class="col-md-3">
                        <label asp-for="Email" class="form-label fw-bold"></label>
                        <input id="Email" asp-for="Email" class="form-control" />
                        <span asp-validation-for="Email" class="text-danger"></span>
                    </div>
                    <div class="col-md-3">
                        <label asp-for="MobileNumber" class="form-label fw-bold"></label>
                        <input id="MobileNumber" asp-for="MobileNumber" class="form-control" />
                        <span asp-validation-for="MobileNumber" class="text-danger"></span>
                    </div>
                </div>
            </div>

            <!-- Section: Job Information -->
            <div class="card mb-4">
                <div class="card-header text-white" style="background-color: #7066E0;color:white">
                    <h6 class="mb-0">Job Information</h6>
                </div>
                <div class="card-body row g-3">
                    <div class="col-md-3">
                        <label asp-for="Band" class="form-label fw-bold"></label>
                        <select id="BandDropdown" asp-for="Band" class="form-select">
                            <option value="">-- Select Band --</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label asp-for="Grade" class="form-label fw-bold"></label>
                        <select id="GradeDropdown" asp-for="Grade" class="form-select">
                            <option value="">-- Select Grade --</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label asp-for="Department" class="form-label fw-bold"></label>
                        <select id="DepartmentDropdown" asp-for="Department" class="form-select">
                            <option value="">-- Select Department --</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label asp-for="Designation" class="form-label fw-bold"></label>
                        <select id="DesignationDropdown" asp-for="Designation" class="form-select">
                            <option value="">-- Select Designation --</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Section: Address -->
            <div class="card mb-4">
                <div class="card-header text-white" style="background-color: #7066E0;color:white">
                    <h6 class="mb-0">Address</h6>
                </div>
                <div class="card-body row g-3">
                    <div class="col-md-4">
                        <label asp-for="Address_Line1" class="form-label fw-bold"></label>
                        <input id="Address_Line1" asp-for="Address_Line1" class="form-control" />
                    </div>
                    <div class="col-md-4">
                        <label asp-for="Address_Line2" class="form-label fw-bold"></label>
                        <input id="Address_Line2" asp-for="Address_Line2" class="form-control" />
                    </div>
                    <div class="col-md-4">
                        <label asp-for="Address_Line3" class="form-label fw-bold"></label>
                        <input id="Address_Line3" asp-for="Address_Line3" class="form-control" />
                    </div>
                </div>
            </div>

            <!-- Section: Dates -->
            <div class="card mb-4">
                <div class="card-header text-white" style="background-color: #7066E0;color:white">
                    <h6 class="mb-0">Important Dates</h6>
                </div>
                <div class="card-body row g-3">
                    <div class="col-md-4">
                        <label for="JoiningDate" class="form-label fw-bold">Joining Date</label>
                        <input type="date" id="JoiningDate" name="JoiningDate" class="form-control" required />
                    </div>
                    <div class="col-md-4">
                        <label for="JoiningDatePlus3Months" class="form-label fw-bold">Probation Date</label>
                        <input type="date" id="JoiningDatePlus3Months" name="JoiningDatePlus3Months" class="form-control" required />
                    </div>
                    <div class="col-md-4">
                        <label for="JoiningDatePlus6Months" class="form-label fw-bold">Permanent Date</label>
                        <input type="date" id="JoiningDatePlus6Months" name="JoiningDatePlus6Months" class="form-control" required />
                    </div>
                </div>
            </div>

            <!-- Section: Preferences -->
            <div class="card mb-4">
                <div class="card-header text-white" style="background-color: #7066E0;color:white">
                    <h6 class="mb-0">Preferences</h6>
                </div>
                <div class="card-body row g-3 align-items-center">
                    <div class="col-md-3 form-check">
                        <input id="OptedNPS" type="checkbox" name="OptedNPS" class="form-check-input" />
                        <label for="OptedNPS" class="form-check-label">Opted for NPS</label>
                    </div>
                    <div class="col-md-3 form-check">
                        <input id="OptedVPF" type="checkbox" name="OptedVPF" class="form-check-input" />
                        <label for="OptedVPF" class="form-check-label">Opted for VPF</label>
                    </div>
                    <div class="col-md-3 form-check">
                        <input id="IsMetro" type="checkbox" name="IsMetro" class="form-check-input" />
                        <label for="IsMetro" class="form-check-label">Is Metro Location</label>
                    </div>
                    <div class="col-md-3">
                        <label asp-for="JobLocation" class="form-label fw-bold"></label>
                        <input id="JobLocation" asp-for="JobLocation" class="form-control" />
                    </div>
                </div>
            </div>

            <!-- Section: Salary Info -->
            <div class="card mb-4">
                <div class="card-header text-white" style="background-color: #7066E0;color:white">
                    <h6 class="mb-0">Salary Information</h6>
                </div>
                <div class="card-body row g-3">
                 

                    <!-- TotalCTC Section -->
                    <div class="col-md-4" id="totalCtcContainer">
                        <label asp-for="TotalCTC" class="form-label fw-bold"></label>
                        <input id="TotalCTCInput" asp-for="TotalCTC" class="form-control" />
                        <select id="TotalCTCDropdown" name="TotalCTC" class="form-select d-none">
                            <option value="">-- Select CTC --</option>
                            <option value="300000">300000</option>
                            <option value="350000">350000</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label asp-for="PFApplicability" class="form-label fw-bold"></label>
                        <select id="PFApplicability" asp-for="PFApplicability" class="form-select">
                            <option value="">--Select PF Applicability--</option>
                            <option value="Full">Full</option>
                            <option value="Fixed 15000">Fixed 15000</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label asp-for="RefNo" class="form-label fw-bold"></label>
                        <input id="RefNo" asp-for="RefNo" class="form-control" />
                    </div>
                </div>
            </div>

            <!-- Submit Button -->
            <div class="text-center">
                <input type="submit" id="saveButton" value="Submit" class="btn text-white px-5" style="background-color: #7066E0;" />
            </div>

           
        </div>

        <div id="result"></div>
   
    </form>




    <!-- Modal -->
    <div class="modal fade" id="emailModal" tabindex="-1" aria-labelledby="emailModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <!-- Modal Header with Close Button -->
                <div class="modal-header">
                    <h5 class="modal-title" id="emailModalLabel">Enter Email</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <!-- Modal Body -->
                <div class="modal-body">
                    <form id="emailCheckForm">
                        <div class="mb-3">
                            <label for="modalEmailInput" class="form-label">Email</label>
                            <input type="email" class="form-control" id="modalEmailInput" required>
                            <div id="emailError" class="text-danger mt-1"></div>
                        </div>
                        <button type="submit" class="btn text-white" style="background-color: #7066E0;">Submit</button>


                    </form>
                </div>

                <!-- Optional Footer -->
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
  
    @section Scripts {

        <script>
            document.addEventListener("DOMContentLoaded", function () {
                const docTypeSelect = document.getElementById("documentType");
                const formFieldsContainer = document.getElementById("formFieldsContainer");

                const allowedFieldsMap = {
                    "1": [
                        "EmployeeName", "JoiningDate", "TotalCTC", "Band", "Grade",
                        "Department", "Designation", "Email", "Address_Line1","Address_Line2","Address_Line3", "JobLocation", "MobileNumber",
                        "PFApplicability", "IsMetro", "OptedNPS", "OptedVPF"
                    ],
                    "2": [
                          "EmployeeName", "JoiningDate", "TotalCTC", "Band", "Grade",
                        "Department", "Designation", "Email", "Address_Line1","Address_Line2","Address_Line3", "JobLocation", "MobileNumber",
                        "PFApplicability", "IsMetro", "OptedNPS", "OptedVPF","JoiningDatePlus3Months", "JoiningDatePlus6Months"
                    ],
                    "3": [
                        "EmployeeId","RefNo","EmployeeName", "JoiningDate", "TotalCTC", "Band", "Grade",
                        "Department", "Designation", "Email", "Address_Line1","Address_Line2","Address_Line3", "JobLocation", "MobileNumber",
                        "PFApplicability", "IsMetro", "OptedNPS", "OptedVPF"
                    ],
                    "4": [
                         "EmployeeId","RefNo","EmployeeName", "JoiningDate", "TotalCTC", "Band", "Grade",
                        "Department", "Designation", "Email", "Address_Line1","Address_Line2","Address_Line3", "JobLocation", "MobileNumber",
                        "PFApplicability", "IsMetro", "OptedNPS", "OptedVPF","JoiningDatePlus3Months", "JoiningDatePlus6Months"
                    ]
                };

                function toggleFields() {
                    const selectedValue = docTypeSelect.value;
                    const allowedFields = allowedFieldsMap[selectedValue] || [];

                    // Show/hide form container
                    formFieldsContainer.style.display = selectedValue ? "block" : "none";

                    formFieldsContainer.querySelectorAll("input, select, textarea").forEach(field => {
                        const parent = field.closest(".col-md-2, .col-md-3, .col-md-4");
                        if (!parent || !field.name) return;

                        if (allowedFields.includes(field.name)) {
                            parent.style.display = "";
                            field.disabled = false;
                        } else {
                            parent.style.display = "none";
                            field.disabled = true;
                        }
                    });
                }

                // Initial run in case form is pre-filled
                toggleFields();

                // Update on change
                docTypeSelect.addEventListener("change", toggleFields);
            });
        </script>

   
        <script>
            $(document).ready(function () {
                $("#documentType").on("change", function () {
                    var selected = $(this).val();

                    if (selected === "2" || selected === "4") {
                        // Show dropdown for fresher document types
                        $("#TotalCTCInput").addClass("d-none").prop("disabled", true);
                        $("#TotalCTCDropdown").removeClass("d-none").prop("disabled", false);
                    } else {
                        // Show input for experienced document types
                        $("#TotalCTCDropdown").addClass("d-none").prop("disabled", true);
                        $("#TotalCTCInput").removeClass("d-none").prop("disabled", false);
                    }

                   if (selected === "2") {
                     // Disable NPS and VPF
                     $("#OptedNPS, #OptedVPF").prop("checked", false).prop("disabled", true);
                     
                     // Set BandDropdown value = 1
                     $("#BandDropdown").val("1");
                    } else {
                        // Enable NPS and VPF
                        $("#OptedNPS, #OptedVPF").prop("disabled", false);
                    
                        // Reset BandDropdown (optional)
                        $("#BandDropdown").val("");
                    }

                });
            });
        </script>

        <script>
            let currentDocType = null;

            const modal = new bootstrap.Modal(document.getElementById('emailModal'));
            const modalEmailInput = document.getElementById('modalEmailInput');
            const emailForm = document.getElementById('emailCheckForm');
            const emailError = document.getElementById('emailError');
            const docTypeSelect = document.getElementById("documentType");

            // ---------- Helper Functions ----------
            function loadGrades(bandName, selectedGrade, callback) {
                $('#GradeDropdown').empty();
                $.getJSON(`/Salary/GetGrades?bandName=${bandName}`, function (data) {
                    $('#GradeDropdown').append(data.map(x => `<option value="${x.value}">${x.text}</option>`));
                    if (selectedGrade) {
                        $('#GradeDropdown').val(selectedGrade).trigger("change");
                    }
                    if (callback) callback();
                });
            }

            function loadDesignations(bandName, gradeName, departmentName, selectedDesignation) {
                $('#DesignationDropdown').empty();
                $.getJSON(`/Salary/GetDesignations?bandName=${bandName}&gradeName=${gradeName}&departmentName=${departmentName}`, function (data) {
                    $('#DesignationDropdown').append(data.map(x => `<option value="${x.value}">${x.text}</option>`));
                    if (selectedDesignation) {
                        $('#DesignationDropdown').val(selectedDesignation);
                    }
                });
            }

            // ---------- DocType Selection ----------
            docTypeSelect.addEventListener("change", function () {
                const selectedValue = docTypeSelect.value;
                if (["1", "2", "3", "4"].includes(selectedValue)) {
                    currentDocType = selectedValue;
                    modalEmailInput.value = "";
                    emailError.textContent = "";
                    modal.show();
                }
            });


                        function setValueAndDisable(id, value) {
                const el = document.getElementById(id);
                if (el) {
                    if (el.type === "checkbox") {
                        el.checked = value || false;
                        // Keep it enabled so its value posts, but block user interaction
                        el.addEventListener("click", function (e) {
                            e.preventDefault();
                        });
                    } else {
                        el.value = value || "";
                        // Make text/date/number readonly
                        el.readOnly = true;

                        // For dropdowns (SELECT) → lock selection
                        if (el.tagName === "SELECT") {
                            el.addEventListener("mousedown", function (e) {
                                e.preventDefault();
                            });
                        }
                    }
                }
            }



            emailForm.addEventListener("submit", async function (e) {
                e.preventDefault();

                const email = modalEmailInput.value.trim();
                if (!email) {
                    emailError.textContent = "Email is required.";
                    return;
                }

                try {
                    const response = await fetch(`/Salary/CheckEmail?email=${encodeURIComponent(email)}&docType=${currentDocType}`);
                    if (!response.ok) {
                        throw new Error("Network response was not ok");
                    }

                    const result = await response.json();

                    if (currentDocType === "1" || currentDocType === "2") {
                        if (result.exists) {
                            emailError.textContent = `Email already exists with ${result.employeeName}.`;
                        } else {
                            document.getElementById("Email").value = email;
                            modal.hide();
                        }
                    } else if (currentDocType === "3" || currentDocType === "4") {
                        if (result.exists) {
                            // Core info
                            document.getElementById("Email").value = result.email;
                            document.getElementById("EmployeeName").value = result.employeeName;

                            // Band first
                            $("#BandDropdown").val(result.band).trigger("change");

                            // Load grades after band, then load designations after grade+dept
                            loadGrades(result.band, result.grade, function () {
                                $("#DepartmentDropdown").val(result.department).trigger("change");
                                loadDesignations(result.band, result.grade, result.department, result.designation);
                            });

                            setValueAndDisable("Email", result.email);
                            setValueAndDisable("EmployeeName", result.employeeName);
                            setValueAndDisable("BandDropdown", result.band);
                            setValueAndDisable("GradeDropdown", result.grade);
                            setValueAndDisable("DepartmentDropdown", result.department);
                            setValueAndDisable("DesignationDropdown", result.designation);
                            setValueAndDisable("JobLocation", result.jobLocation);
                            setValueAndDisable("PFApplicability", result.pfApplicability);
                            setValueAndDisable("MobileNumber", result.mobileNumber);
                            setValueAndDisable("Address_Line1", result.address_Line1);
                            setValueAndDisable("Address_Line2", result.address_Line2);
                            setValueAndDisable("Address_Line3", result.address_Line3);
                            setValueAndDisable("TotalCTCInput", result.totalCTC);
                            setValueAndDisable("OptedNPS", result.optedNPS);
                            setValueAndDisable("OptedVPF", result.optedVPF);
                            setValueAndDisable("IsMetro", result.isMetro);


                            // Dates
                            if (result.joiningDate) {
                                //document.getElementById("JoiningDate").value = result.joiningDate;
                                setValueAndDisable("JoiningDate", result.joiningDate);

                            }
                            if (result.joiningDatePlus3Months) {
                               // document.getElementById("JoiningDatePlus3Months").value = result.joiningDatePlus3Months;
                               setValueAndDisable("JoiningDatePlus3Months", result.joiningDatePlus3Months);

                            }
                            if (result.joiningDatePlus6Months) {
                                //document.getElementById("JoiningDatePlus6Months").value = result.joiningDatePlus6Months;
                               setValueAndDisable("JoiningDatePlus6Months", result.joiningDatePlus6Months);

                            }

                            modal.hide();
                        } else {
                            emailError.textContent = "Offer Letter does not exist. Kindly generate Offer Letter first.";
                        }
                    }
                } catch (error) {
                    console.error("Error:", error);
                    emailError.textContent = "Error checking email. Try again later.";
                }
            });
        </script>
     

        <script>
            $(document).ready(function () {
           


            // On documentType change, reload bands
            $("#documentType").on("change", function () {
                var selected = $(this).val();

                // Fetch bands again based on documentType
                $.getJSON(`/Salary/GetBands?documentType=${selected}`, function (data) {
                    var $bandDropdown = $('#BandDropdown');
                    $bandDropdown.empty();
                    $bandDropdown.append('<option value="">-- Select Band --</option>');
                    $.each(data, function (i, item) {
                        $bandDropdown.append(`<option value="${item.value}">${item.text}</option>`);
                    });

                    if (selected === "2") {
                        // Auto-select T
                        $bandDropdown.val("T").trigger("change");
               
                    }
                });
            });

          

                $.getJSON('/Salary/GetDepartments', function (data) {
                     var $departmentDropdown = $('#DepartmentDropdown');
                     $departmentDropdown.empty(); // clear old options
                     $departmentDropdown.append('<option value="">-- Select Department --</option>');
                     $.each(data, function (i, item) {
                         $departmentDropdown.append(`<option value="${item.value}">${item.text}</option>`);
                    });
                });

                $('#BandDropdown').change(function () {
                    var bandName = $(this).val();
                    $('#GradeDropdown').empty();
                    $('#DesignationDropdown').empty();
                    $.getJSON(`/Salary/GetGrades?bandName=${bandName}`, function (data) {
                        $('#GradeDropdown').append(data.map(x => `<option value="${x.value}">${x.text}</option>`));
                    });
                });

                $('#GradeDropdown, #DepartmentDropdown').change(function () {
                    var bandName = $('#BandDropdown').val();
                    var gradeName = $('#GradeDropdown').val();
                    var departmentName = $('#DepartmentDropdown').val();
                    $('#DesignationDropdown').empty();
                    if (bandName && gradeName && departmentName) {
                        $.getJSON(`/Salary/GetDesignations?bandName=${bandName}&gradeName=${gradeName}&departmentName=${departmentName}`, function (data) {
                            $('#DesignationDropdown').append(data.map(x => `<option value="${x.value}">${x.text}</option>`));
                        });
                    }
                });
            });
        </script>



        <script>
            document.addEventListener("DOMContentLoaded", function () {
                const isMetroCheckbox = document.getElementById("IsMetro");
                const jobLocationInput = document.getElementById("JobLocation");

                isMetroCheckbox.addEventListener("change", function () {
                    if (this.checked) {
                        jobLocationInput.value = "Mumbai";
                        jobLocationInput.readOnly = true;
                    } else {
                        jobLocationInput.value = "";
                        jobLocationInput.readOnly = false;
                    }
                });
            });
        </script>



        @* <script>
            document.getElementById("salaryForm").addEventListener("submit", async function (e) {
                e.preventDefault();

                const form = e.target;

                // ✅ Trigger browser form validation
                if (!form.checkValidity())
                {
                    form.reportValidity(); // shows validation UI
                    return;
                }

                const formData = new FormData(form);
                const json = {};

                formData.forEach((value, key) => {
                    if (key === "IsMetro" || key === "OptedNPS" || key === "OptedVPF") {
                        json[key] = form[key].checked;
                    } else if (key === "TotalCTC" || key === "ChosenRFB") {
                        json[key] = parseFloat(value);
                    } else if (key === "DocumentType") {
                        json[key] = parseInt(value);
                    } else {
                        json[key] = value;
                    }
                });

                const response = await fetch('/Salary/CalculateSalaryBreakdown', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(json)
                });

                const resultDiv = document.getElementById("result");

                // if (response.ok) {
                //     const blob = await response.blob();
                //     const url = window.URL.createObjectURL(blob);
                //     const a = document.createElement('a');
                //     a.href = url;
                //     a.download = "SalaryBreakdown.pdf"; or dynamically name it
                //     document.body.appendChild(a);
                //     a.click();
                //     a.remove();
                //     window.URL.revokeObjectURL(url);

                //     resultDiv.innerHTML = "<p><strong>PDF downloaded successfully.</strong></p>";
                // } else {
                //     const errorText = await response.text();
                //     resultDiv.innerHTML = `<p style="color:red;">Error submitting form: ${errorText}</p>`;
                // }

                if (response.ok) {
                const data = await response.json();

                // ✅ Show popup alert (SweetAlert2 or simple alert)
                Swal.fire({
                    icon: "success",
                    title: "Success",
                    text: data.message
                });

                resultDiv.innerHTML = `<p style="color:green;"><strong>${data.message}</strong></p>`;
                } else {
                    const error = await response.json();
                    Swal.fire({
                        icon: "error",
                        title: "Error",
                        text: error.message || "Something went wrong"
                    });

                    resultDiv.innerHTML = `<p style="color:red;">Error submitting form: ${error.message}</p>`;
                }

            });
        </script> *@

        <script>
            // Get today's date in YYYY-MM-DD format
            const today = new Date().toISOString().split('T')[0];
            // Set it as the min attribute of the input
            document.getElementById("JoiningDate").setAttribute("min", today);
            document.getElementById("JoiningDatePlus3Months").setAttribute("min", today);
            document.getElementById("JoiningDatePlus6Months").setAttribute("min", today);
        </script>
     
    

        @* <script>
            $("#saveButton").on("click", function () {
         
                fetch("/Salary/CalculateSalaryBreakdown", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                Swal.fire({
                    icon: "success",
                    title: "Success",
                    text: data.message
                }).then((result) => {
                    if (result.isConfirmed) {
                        // Redirect to GET action after pressing OK
                          //console.log("Redirecting now...");
                        window.location.href = "/Salary/CalculateSalaryBreakdown";
                    }
                });
            })
            .catch(err => {
                Swal.fire({
                    icon: "error",
                    title: "Error",
                    text: "Something went wrong while saving data."
                });
            });

            });
        </script> *@

        <script>
            document.getElementById("salaryForm").addEventListener("submit", async function (e) {
                e.preventDefault(); // prevent default

                const form = e.target;
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }

                const formData = new FormData(form);
                const json = {};

                formData.forEach((value, key) => {
                    if (key === "IsMetro" || key === "OptedNPS" || key === "OptedVPF") {
                        json[key] = form[key].checked;
                    } else if (key === "TotalCTC" || key === "ChosenRFB") {
                        json[key] = parseFloat(value);
                    } else if (key === "DocumentType") {
                        json[key] = parseInt(value);
                    } else {
                        json[key] = value;
                    }
                });

                try {
                    const response = await fetch('/Salary/CalculateSalaryBreakdown', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(json)
                    });

                    if (!response.ok) throw response;

                    const data = await response.json();

                    Swal.fire({
                        icon: "success",
                        title: "Success",
                        text: data.message
                    }).then(() => {
                        // ✅ Redirect to GET action
                        window.location.href = '/Salary/CalculateSalaryBreakdown';
                    });

                } catch (err) {
                    let errorMsg = "Something went wrong";
                    try {
                        const errorData = await err.json();
                        errorMsg = errorData.message || errorMsg;
                    } catch {}

                    Swal.fire({
                        icon: "error",
                        title: "Error",
                        text: errorMsg
                    });
                }
            });
        </script>




        @{
            await Html.RenderPartialAsync("_ValidationScriptsPartial");
        }

    }

    </body>
</html>

