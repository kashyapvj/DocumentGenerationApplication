@using DocumentGenerationApplication.Models.Tables
@model DocumentGenerationApplication.Models.UI_Model.SalaryBreakdownInput

@{
    ViewData["Title"] = "CalculateSalaryBreakdown";
    Layout = "_Layout";
    var today = DateTime.Today.ToString("yyyy-MM-dd");

}

<html>
    <head>
    <link href="../lib/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet" />

    <style>
        body {
            /*background-color: #F6F2FD /* Or #D3D3D3 for the exact light grey hex code */
            background-color: #E3E3E3 /* Or #D3D3D3 for the exact light grey hex code */
        }

    </style>
    </head>
    <body id="Body">


    <!-- all your sections: Employee Details, Job Info, Address, Dates, Preferences, Salary -->
    <form id="salaryForm" asp-controller="Salary" asp-action="CalculateSalaryBreakdown" method="post" class="container mt-4 shadow p-4 rounded bg-light">
        <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

        <!-- Section: Document Type -->
        <div class="card mb-4">
            <div class="card-header text-white" style="background-color: #7066E0;color:white">
                <h6 class="mb-0">Document Details</h6>
            </div>
            <div class="card-body row g-3">
          
                <div class="col-md-4">
                    <label for="DocumentType" class="form-label fw-bold">Document Type</label>
                    <select id="documentType" name="DocumentType" class="form-select" required>
                        <option value="">-- Select Document Type --</option>
                        <option value="1">Offer Letter Experienced</option>
                        <option value="2">Offer Letter Fresher</option>
                        <option value="5">Offer Letter Intern</option>
                        <option value="3">Appointment Letter Experienced</option>
                        <option value="4">Appointment Letter Fresher</option>
                        @* <option value="6">Relieving & Experience Letter</option>
                        <option value="7">Internship Certificate</option> *@
                    </select>
                    <span id="DocumentTypeValidation" class="text-danger"></span>
                </div>

            </div>
        </div>


        <!-- Section: Form Fields Container -->
        <div id="formFieldsContainer">
            <!-- Section: Employee Details -->
            <div class="card mb-4">
                <div class="card-header text-white" style="background-color: #7066E0;color:white">
                    <h6 class="mb-0">Employee Details</h6>
                </div>
                <div class="card-body row g-3">
                    <div class="col-md-3">
                        <label for="EmployeeId" class="form-label fw-bold">Employee Id</label>
                        <input id="EmployeeId" name="EmployeeId" class="form-control" required />
                    </div>

                    <div class="col-md-3">
                        <label for="EmployeeName" class="form-label fw-bold">EmployeeName</label>
                        <input id="EmployeeName" name="EmployeeName" class="form-control" required />
                    </div>

                    <div class="col-md-3">
                        <label for="Email" class="form-label fw-bold">Email</label>
                        <input id="Email" name="Email" class="form-control" required />
                    </div>

                    <div class="col-md-3">
                        <label for="MobileNumber" class="form-label fw-bold">MobileNumber</label>
                        <input id="MobileNumber" name="MobileNumber" class="form-control" maxlength="10"
                               oninput="this.value=this.value.replace(/[^0-9]/g,'');" required />
                    </div>

                </div>
            </div>

            <!-- Section: Job Information -->
            <div class="card mb-4">
                <div class="card-header text-white" style="background-color: #7066E0;color:white">
                    <h6 class="mb-0">Job Information</h6>
                </div>
                <div class="card-body row g-3">
                    <div class="col-md-3">
                        <label asp-for="Band" class="form-label fw-bold"></label>
                        <select id="BandDropdown" asp-for="Band" class="form-select" required>
                            <option value="">-- Select Band --</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label asp-for="Grade" class="form-label fw-bold"></label>
                        <select id="GradeDropdown" asp-for="Grade" class="form-select" required>
                            <option value="">-- Select Grade --</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label asp-for="Department" class="form-label fw-bold"></label>
                        <select id="DepartmentDropdown" asp-for="Department" class="form-select" required>
                            <option value="">-- Select Department --</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label asp-for="Designation" class="form-label fw-bold"></label>
                        <select id="DesignationDropdown" asp-for="Designation" class="form-select" required>
                            <option value="">-- Select Designation --</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Section: Address -->
            <div class="card mb-4">
                <div class="card-header text-white" style="background-color: #7066E0;color:white">
                    <h6 class="mb-0">Address</h6>
                </div>
                <div class="card-body row g-3">
          
                    <div class="col-md-4">
                        <label for="Address_Line1" class="form-label fw-bold">Address Line 1</label>
                        <input id="Address_Line1" name="Address_Line1" class="form-control" required />
                    </div>

                    <div class="col-md-4">
                        <label for="Address_Line2" class="form-label fw-bold">Address Line 2</label>
                        <input id="Address_Line2" name="Address_Line2" class="form-control" required/>
                    </div>

                    <div class="col-md-4">
                        <label for="Address_Line3" class="form-label fw-bold">Address Line 3</label>
                        <input id="Address_Line3" name="Address_Line3" class="form-control" required/>
                    </div>

                </div>
            </div>

            <!-- Section: Dates -->
            <div class="card mb-4">
                <div class="card-header text-white" style="background-color: #7066E0;color:white">
                    <h6 class="mb-0">Important Dates</h6>
                </div>
                <div class="card-body row g-3">
                    <div class="col-md-4">
                        <label for="JoiningDate" class="form-label fw-bold">Joining Date</label>
                        <input type="date" id="JoiningDate" name="JoiningDate" class="form-control" required />
                    </div>
                    <div class="col-md-4">
                        <label for="JoiningDatePlus3Months" class="form-label fw-bold">Probation Date</label>
                        <input type="date" id="JoiningDatePlus3Months" name="JoiningDatePlus3Months" class="form-control" required />
                    </div>
                    <div class="col-md-4">
                        <label for="JoiningDatePlus6Months" class="form-label fw-bold">Permanent Date</label>
                        <input type="date" id="JoiningDatePlus6Months" name="JoiningDatePlus6Months" class="form-control" required />
                    </div>
                </div>
            </div>

            <!-- Section: Preferences -->
            <div class="card mb-4">
                <div class="card-header text-white" style="background-color: #7066E0;color:white">
                    <h6 class="mb-0">Preferences</h6>
                </div>
                <div class="card-body row g-3 align-items-center">
                    <div class="col-md-3 form-check">
                        <input id="OptedNPS" type="checkbox" name="OptedNPS" class="form-check-input"/>
                        <label for="OptedNPS" class="form-check-label">Opted for NPS</label>
                    </div>
                    <div class="col-md-3 form-check">
                        <input id="OptedVPF" type="checkbox" name="OptedVPF" class="form-check-input"/>
                        <label for="OptedVPF" class="form-check-label">Opted for VPF</label>
                    </div>
                    <div class="col-md-3 form-check">
                        <input id="IsMetro" type="checkbox" name="IsMetro" class="form-check-input"/>
                        <label for="IsMetro" class="form-check-label">Is Metro Location</label>
                    </div>
               
                    <div class="col-md-3">
                       
                        <label for="JobLocation" class="form-label fw-bold">JobLocation</label>
                        <input id="JobLocation" name="JobLocation" class="form-control" required />
                        <!-- Dropdown container -->
                        <div id="metroDropdownContainer" style="display: none; margin-top: 8px;">
                            <select id="MetroCitiesDropdown" class="form-control">
                                <option value="">-- Select Metro City --</option>
                                <option value="Navi Mumbai">Navi Mumbai</option>
                                <option value="Delhi">Delhi</option>
                                <option value="Chennai">Chennai</option>
                                <option value="Kolkata">Kolkata</option>
                                <option value="Bengaluru">Bengaluru</option>
                                <option value="Hyderabad">Hyderabad</option>
                                <option value="Ahmedabad">Ahmedabad</option>
                                <option value="Nagpur">Nagpur</option> 
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section: Salary Info -->
            <div class="card mb-4">
                <div class="card-header text-white" style="background-color: #7066E0;color:white">
                    <h6 class="mb-0">Salary Information</h6>
                </div>
                <div class="card-body row g-3">


                    <!-- TotalCTC Section -->
                    <div class="col-md-4" id="totalCtcContainer">
                        <label for="TotalCTCInput" class="form-label fw-bold">Total CTC</label>

                        <!-- Input field -->
                        <input id="TotalCTCInput" name="TotalCTC" class="form-control" maxlength="9" required />

                     

                        <!-- Validation message -->
                        <span id="TotalCTCValidation" class="text-danger"></span>
                    </div>

                    <div class="col-md-4">
                        <label for="PFApplicability" class="form-label fw-bold">PF Applicability</label>
                        <select id="PFApplicability" name="PFApplicability" class="form-select" required>
                            <option value="">--Select PF Applicability--</option>
                            <option value="Full">Full</option>
                            <option value="Fixed 15000">Fixed 15000</option>
                        </select>
                    </div>

                    <div class="col-md-4">
                        <label for="WorkingDays" class="form-label fw-bold">Working Days</label>
                        <select id="WorkingDays" name="WorkingDays" class="form-select" required>
                            <option value="">--Select Working Days--</option>
                            <option value=" 5">5</option>
                            <option value=" 6">6</option>
                        </select>
                    </div>

                    <div class="col-md-4">
                        <label for="RefNo" class="form-label fw-bold">Ref No</label>
                        <input id="RefNo" name="RefNo" class="form-control" required/>
                    </div>

                    <div class="col-md-4">
                        <div class="form-check mb-2">
                            <input type="checkbox" id="IsBonusApplicable" name="IsBonusApplicable" class="form-check-input" />
                            <label for="IsBonusApplicable" class="form-check-label">IsBonusApplicable</label>
                        </div>
                    </div>

                    <div class="col-md-4" id="bonusAmountDiv" style="display:none;">
                        <label for="BonusAmount" class="form-label">Bonus Amount</label>
                        <input type="text" id="BonusAmount" name="BonusAmount" class="form-control" placeholder="Enter Bonus Amount" />
                    </div>

                    <div class="col-md-4">
                        <div class="form-check mb-2">
                            <input type="checkbox" id="IsProbationApplicable" name="IsProbationApplicable" class="form-check-input" />
                            <label for="IsProbationApplicable" class="form-check-label">IsProbationApplicable</label>
                        </div>
                    </div>

                

                </div>

               
            </div>

            <!-- Submit Button -->
            <div class="text-center">
                <input type="submit" id="saveButton" value="Preview" class="btn text-white px-5" style="background-color: #7066E0;" />
            </div>

           
        </div>

        <div id="result"></div>
   
    </form>




    <!-- Email Modal -->
    <div class="modal fade" id="emailModal" tabindex="-1" aria-labelledby="emailModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <!-- Modal Header with Close Button -->
                <div class="modal-header">
                    <h5 class="modal-title" id="emailModalLabel">Enter Email</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <!-- Modal Body -->
                <div class="modal-body">
                    <form id="emailCheckForm">
                        <div class="mb-3">
                            <label for="modalEmailInput" class="form-label">Email</label>
                            <input type="email" class="form-control" id="modalEmailInput" required>
                            <div id="emailError" class="text-danger mt-1"></div>
                        </div>
                        <button type="submit" class="btn text-white" style="background-color: #7066E0;">Submit</button>


                    </form>
                </div>

                <!-- Optional Footer -->
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- PDF Preview Modal -->
    <div class="modal fade" id="pdfPreviewModal" tabindex="-1" aria-labelledby="pdfPreviewModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content shadow-lg rounded-3">
                <div class="modal-header text-white" style="background-color: #7066E0;">
                    <h5 class="modal-title fw-bold" id="pdfPreviewModalLabel">PDF Preview</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body p-0">
                    <!-- Loader -->
                    <div id="pdfLoader" class="d-flex justify-content-center align-items-center p-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <span class="ms-2">Generating Preview...</span>
                    </div>

                    <!-- PDF iframe -->
                    <iframe id="pdfPreviewFrame" src="" class="w-100 d-none" style="height:80vh; border:none;"></iframe>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary rounded-pill" data-bs-dismiss="modal">Close</button>
                    <button type="button" id="confirmPdfBtn" class="btn btn-success rounded-pill">Confirm</button>
                </div>
            </div>
        </div>
    </div>

  
    @section Scripts {

        <script>
            document.addEventListener("DOMContentLoaded", function () {
                const docTypeSelect = document.getElementById("documentType");
                const formFieldsContainer = document.getElementById("formFieldsContainer");

                const allowedFieldsMap = {
                    "1": [
                        "EmployeeName", "JoiningDate", "TotalCTC", "Band", "Grade",
                        "Department", "Designation", "Email", "Address_Line1","Address_Line2","Address_Line3", "JobLocation", "MobileNumber",
                        "PFApplicability", "IsMetro", "OptedNPS", "OptedVPF","IsBonusApplicable", "BonusAmount"
                    ],
                    "2": [
                          "EmployeeName", "JoiningDate", "TotalCTC", "Band", "Grade",
                        "Department", "Designation", "Email", "Address_Line1","Address_Line2","Address_Line3", "JobLocation", "MobileNumber",
                        "PFApplicability", "IsMetro", "OptedNPS", "OptedVPF","JoiningDatePlus3Months", "JoiningDatePlus6Months","IsBonusApplicable","BonusAmount"
                    ],
                    "3": [
                        "EmployeeId","RefNo","EmployeeName", "JoiningDate", "TotalCTC", "Band", "Grade",
                        "Department", "Designation", "Email", "Address_Line1","Address_Line2","Address_Line3", "JobLocation", "MobileNumber",
                        "PFApplicability","WorkingDays", "IsMetro", "OptedNPS", "OptedVPF","IsBonusApplicable","BonusAmount","IsProbationApplicable"
                    ],
                    "4": [
                         "EmployeeId","RefNo","EmployeeName", "JoiningDate", "TotalCTC", "Band", "Grade",
                        "Department", "Designation", "Email", "Address_Line1","Address_Line2","Address_Line3", "JobLocation", "MobileNumber",
                        "PFApplicability","WorkingDays", "IsMetro", "OptedNPS", "OptedVPF","JoiningDatePlus3Months", "JoiningDatePlus6Months", "IsBonusApplicable","BonusAmount", "IsProbationApplicable"
                    ]
                };

                function toggleFields() {
                    const selectedValue = docTypeSelect.value;
                    const allowedFields = allowedFieldsMap[selectedValue] || [];

                    // Show/hide form container
                    formFieldsContainer.style.display = selectedValue ? "block" : "none";

                    formFieldsContainer.querySelectorAll("input, select, textarea").forEach(field => {
                        const parent = field.closest(".col-md-2, .col-md-3, .col-md-4");
                        if (!parent || !field.name) return;

                        if (allowedFields.includes(field.name)) {
                            parent.style.display = "";
                            field.disabled = false;
                        } else {
                            parent.style.display = "none";
                            field.disabled = true;
                        }
                    });
                }

                // Initial run in case form is pre-filled
                toggleFields();

                // Update on change
                docTypeSelect.addEventListener("change", toggleFields);
            });
        </script>

        <script>
            $(document).ready(function () {
                $("#documentType").on("change", function () {
                    var selected = $(this).val();

                    if (selected === "2" || selected === "4") {
                        // For Fresher document types

                        // Total CTC (readonly)
                        $("#TotalCTCInput")
                            .val("300000")
                            .prop("readonly", true)
                            .css("background-color", "#e9ecef");

                        // Band (readonly workaround)
                        $("#BandDropdown")
                            .val("T")
                            .css("background-color", "#e9ecef")
                            .attr("data-readonly", "true");

                        // Grade (readonly workaround)
                        $("#GradeDropdown")
                            .val("T1")
                            .css("background-color", "#e9ecef")
                            .attr("data-readonly", "true");

                        // PF Applicability (readonly workaround)
                        $("#PFApplicability")
                            .val("Fixed 15000")
                            .css("background-color", "#e9ecef")
                            .attr("data-readonly", "true");

                        // Disable NPS and VPF (checkboxes can be disabled safely)
                        $("#OptedNPS, #OptedVPF")
                            .prop("checked", false)
                            .prop("disabled", true);
                    }
                    else {
                        // For Experienced or other document types

                        // Total CTC
                        $("#TotalCTCInput")
                            .prop("readonly", false)
                            .css("background-color", "")
                            .val("");

                        // Band, Grade, PF Applicability (remove readonly simulation)
                        $("#BandDropdown, #GradeDropdown, #PFApplicability")
                            .removeAttr("data-readonly")
                            .css("background-color", "")
                            .val("");

                        // Enable NPS and VPF
                        $("#OptedNPS, #OptedVPF").prop("disabled", false);
                    }
                });

                // Prevent changing dropdowns that are marked readonly
                $(document).on("mousedown", "select[data-readonly='true']", function (e) {
                    e.preventDefault(); // Prevent dropdown opening
                });
            });
        </script>




        <script>
            let currentDocType = null;

            const modal = new bootstrap.Modal(document.getElementById('emailModal'));
            const modalEmailInput = document.getElementById('modalEmailInput');
            const emailForm = document.getElementById('emailCheckForm');
            const emailError = document.getElementById('emailError');
            const docTypeSelect = document.getElementById("documentType");

            // ---------- Helper Functions ----------
            function loadGrades(bandName, selectedGrade, callback) {
                $('#GradeDropdown').empty();
                $.getJSON(`/Salary/GetGrades?bandName=${bandName}`, function (data) {
                    $('#GradeDropdown').append(data.map(x => `<option value="${x.value}">${x.text}</option>`));
                    if (selectedGrade) {
                        $('#GradeDropdown').val(selectedGrade).trigger("change");
                    }
                    if (callback) callback();
                });
            }

            function loadDesignations(bandName, gradeName, departmentName, selectedDesignation) {
                $('#DesignationDropdown').empty();
                $.getJSON(`/Salary/GetDesignations?bandName=${bandName}&gradeName=${gradeName}&departmentName=${departmentName}`, function (data) {
                    $('#DesignationDropdown').append(data.map(x => `<option value="${x.value}">${x.text}</option>`));
                    if (selectedDesignation) {
                        $('#DesignationDropdown').val(selectedDesignation);
                    }
                });
            }

            // ---------- DocType Selection ----------
            docTypeSelect.addEventListener("change", function () {
                const selectedValue = docTypeSelect.value;
                if (["1", "2", "3", "4"].includes(selectedValue)) {
                    currentDocType = selectedValue;
                    modalEmailInput.value = "";
                    emailError.textContent = "";
                    modal.show();
                }
            });


                        function setValueAndDisable(id, value) {
                const el = document.getElementById(id);
                if (el) {
                    if (el.type === "checkbox") {
                        el.checked = value || false;
                        // Keep it enabled so its value posts, but block user interaction
                        el.addEventListener("click", function (e) {
                            e.preventDefault();
                        });
                    } else {
                        el.value = value || "";
                        // Make text/date/number readonly
                        el.readOnly = true;

                        // For dropdowns (SELECT) → lock selection
                        if (el.tagName === "SELECT") {
                            el.addEventListener("mousedown", function (e) {
                                e.preventDefault();
                            });
                        }
                    }
                }
            }

            emailForm.addEventListener("submit", async function (e) {
                e.preventDefault();

                const email = modalEmailInput.value.trim();
                if (!email) {
                    emailError.textContent = "Email is required.";
                    return;
                }

                try {
                    const response = await fetch(`/Salary/CheckEmail?email=${encodeURIComponent(email)}&docType=${currentDocType}`);
                    if (!response.ok) {
                        throw new Error("Network response was not ok");
                    }

                    const result = await response.json();

                    if (currentDocType === "1" || currentDocType === "2") {
                        if (result.exists) {
                            emailError.textContent = `Email already exists with ${result.employeeName}.`;
                        } else {
                            document.getElementById("Email").value = email;
                            modal.hide();
                        }
                    } else if (currentDocType === "3" || currentDocType === "4") {
                        if (result.exists) {
                            // Core info
                            document.getElementById("Email").value = result.email;
                            document.getElementById("EmployeeName").value = result.employeeName;

                            // Band first
                            $("#BandDropdown").val(result.band).trigger("change");

                            // Load grades after band, then load designations after grade+dept
                            loadGrades(result.band, result.grade, function () {
                                $("#DepartmentDropdown").val(result.department).trigger("change");
                                loadDesignations(result.band, result.grade, result.department, result.designation);
                            });

                            setValueAndDisable("Email", result.email);
                            setValueAndDisable("EmployeeName", result.employeeName);
                            setValueAndDisable("BandDropdown", result.band);
                            setValueAndDisable("GradeDropdown", result.grade);
                            setValueAndDisable("DepartmentDropdown", result.department);
                            setValueAndDisable("DesignationDropdown", result.designation);
                            setValueAndDisable("JobLocation", result.jobLocation);
                            setValueAndDisable("PFApplicability", result.pfApplicability);
                            setValueAndDisable("MobileNumber", result.mobileNumber);
                            setValueAndDisable("Address_Line1", result.address_Line1);
                            setValueAndDisable("Address_Line2", result.address_Line2);
                            setValueAndDisable("Address_Line3", result.address_Line3);
                            setValueAndDisable("TotalCTCInput", result.totalCTC);
                            setValueAndDisable("OptedNPS", result.optedNPS);
                            setValueAndDisable("OptedVPF", result.optedVPF);
                            setValueAndDisable("IsMetro", result.isMetro);


                            // Dates
                            if (result.joiningDate) {
                                //document.getElementById("JoiningDate").value = result.joiningDate;
                                setValueAndDisable("JoiningDate", result.joiningDate);

                            }
                            if (result.joiningDatePlus3Months) {
                               // document.getElementById("JoiningDatePlus3Months").value = result.joiningDatePlus3Months;
                               setValueAndDisable("JoiningDatePlus3Months", result.joiningDatePlus3Months);

                            }
                            if (result.joiningDatePlus6Months) {
                                //document.getElementById("JoiningDatePlus6Months").value = result.joiningDatePlus6Months;
                               setValueAndDisable("JoiningDatePlus6Months", result.joiningDatePlus6Months);

                            }

                            modal.hide();
                        } else {
                            emailError.textContent = "Offer Letter does not exist. Kindly generate Offer Letter first.";
                        }
                    }
                } catch (error) {
                    console.error("Error:", error);
                    emailError.textContent = "Error checking email. Try again later.";
                }
            });
        </script>
     

        <script>
            $(document).ready(function () {
           


            // On documentType change, reload bands
            $("#documentType").on("change", function () {
                var selected = $(this).val();

                // Fetch bands again based on documentType
                $.getJSON(`/Salary/GetBands?documentType=${selected}`, function (data) {
                    var $bandDropdown = $('#BandDropdown');
                    $bandDropdown.empty();
                    $bandDropdown.append('<option value="">-- Select Band --</option>');
                    $.each(data, function (i, item) {
                        $bandDropdown.append(`<option value="${item.value}">${item.text}</option>`);
                    });

                    if (selected === "2") {
                        // Auto-select T
                        $bandDropdown.val("T").trigger("change");
               
                    }
                });
            });

          

                $.getJSON('/Salary/GetDepartments', function (data) {
                     var $departmentDropdown = $('#DepartmentDropdown');
                     $departmentDropdown.empty(); // clear old options
                     $departmentDropdown.append('<option value="">-- Select Department --</option>');
                     $.each(data, function (i, item) {
                         $departmentDropdown.append(`<option value="${item.value}">${item.text}</option>`);
                    });
                });

                $('#BandDropdown').change(function () {
                    var bandName = $(this).val();
                    $('#GradeDropdown').empty();
                    $('#DesignationDropdown').empty();
                    $.getJSON(`/Salary/GetGrades?bandName=${bandName}`, function (data) {
                        $('#GradeDropdown').append(data.map(x => `<option value="${x.value}">${x.text}</option>`));
                    });
                });

                $('#GradeDropdown, #DepartmentDropdown').change(function () {
                    var bandName = $('#BandDropdown').val();
                    var gradeName = $('#GradeDropdown').val();
                    var departmentName = $('#DepartmentDropdown').val();
                    $('#DesignationDropdown').empty();
                    if (bandName && gradeName && departmentName) {
                        $.getJSON(`/Salary/GetDesignations?bandName=${bandName}&gradeName=${gradeName}&departmentName=${departmentName}`, function (data) {
                            $('#DesignationDropdown').append(data.map(x => `<option value="${x.value}">${x.text}</option>`));
                        });
                    }
                });
            });
        </script>

        <script>
            document.addEventListener("DOMContentLoaded", function () {
                const isMetroCheckbox = document.getElementById("IsMetro");
                const jobLocationInput = document.getElementById("JobLocation");
                const dropdownContainer = document.getElementById("metroDropdownContainer");
                const metroDropdown = document.getElementById("MetroCitiesDropdown");

                // Metro cities list
                const metroCities = [
                    "Navi Mumbai", "Delhi", "Chennai", "Kolkata",
                    "Bengaluru", "Hyderabad","Nagpur", "Ahmedabad", "Mumbai"
                ];

                // Toggle dropdown and input visibility
                isMetroCheckbox.addEventListener("change", function () {
                    if (this.checked) {
                        jobLocationInput.style.display = "none";
                        dropdownContainer.style.display = "block";
                        jobLocationInput.value = "";
                    } else {
                        dropdownContainer.style.display = "none";
                        jobLocationInput.style.display = "block";
                        jobLocationInput.value = "";
                    }
                });

                // Sync dropdown value with JobLocation input (for form submission)
                metroDropdown.addEventListener("change", function () {
                    const selectedCity = this.value;
                    jobLocationInput.value = selectedCity;
                });

                // Validate metro city input when IsMetro is not checked
                jobLocationInput.addEventListener("blur", function () {
                    const enteredValue = jobLocationInput.value.trim().toLowerCase();
                    const isMetroEntered = metroCities.some(city => city.toLowerCase() === enteredValue);

                    if (isMetroEntered && !isMetroCheckbox.checked) {
                        Swal.fire({
                            title: "Alert",
                            text: "You have entered a metro city. Please select the 'Is Metro City' checkbox, and then choose an option from the dropdown.",
                            icon: "warning",
                            confirmButtonColor: "#7066E0",
                            confirmButtonText: "OK"
                        }).then(() => {
                            jobLocationInput.value = "";
                            jobLocationInput.focus();
                        });
                    }
                });
            });
        </script>



        <script>
            // Get today's date in YYYY-MM-DD format
            const today = new Date().toISOString().split('T')[0];
            // Set it as the min attribute of the input
            document.getElementById("JoiningDate").setAttribute("min", today);
            document.getElementById("JoiningDatePlus3Months").setAttribute("min", today);
            document.getElementById("JoiningDatePlus6Months").setAttribute("min", today);
        </script>


        <script>
            document.addEventListener("DOMContentLoaded", function () {
                const totalCtcInput = document.getElementById("TotalCTCInput");

                // Block copy, paste, cut, drag/drop
                ["paste", "copy", "cut", "drop"].forEach(evt =>
                    totalCtcInput.addEventListener(evt, e => e.preventDefault())
                );

                // Allow only numbers while typing
                totalCtcInput.addEventListener("keypress", function (e) {
                    if (!/[0-9]/.test(e.key)) {
                        e.preventDefault();
                    }
                });
            });
        </script>

        <script>
            function openPdfPreview(employeeId, documentType) {
                const pdfFrame = document.getElementById("pdfPreviewFrame");
                const pdfLoader = document.getElementById("pdfLoader");

                const templateMap = {
                    1: "Offer Letter (Experienced)",
                    2: "Offer Letter (Fresher)",
                    3: "Appointment Letter (Experienced)",
                    4: "Appointment Letter (Fresher)"
                };

                // Update modal title based on doc type
                document.getElementById("pdfPreviewModalLabel").innerText =
                    "Preview - " + (templateMap[documentType] || "Document");

                // Show loader
                pdfLoader.classList.remove("d-none");
                pdfFrame.classList.add("d-none");
                pdfFrame.src = "";

                // Dynamic preview URL → handled by backend
                const previewUrl = `/OfferLetter/PreviewPdf?employeeId=${employeeId}&documentType=${documentType}`;
                pdfFrame.src = previewUrl;

                // On load, hide loader
                pdfFrame.onload = function () {
                    pdfLoader.classList.add("d-none");
                    pdfFrame.classList.remove("d-none");
                };

                // Show modal
                const modal = new bootstrap.Modal(document.getElementById("pdfPreviewModal"));
                modal.show();

                // Confirm handler
                document.getElementById("confirmPdfBtn").onclick = function () {
                    alert("Confirmed " + templateMap[documentType] + " for Employee: " + employeeId);
                    modal.hide();
                };
            }
        </script>


        <script>
            document.getElementById("salaryForm").addEventListener("submit", async function (e) {
                e.preventDefault(); // Stop form submission always

                const form = e.target;

                // --- 🔒 Bonus validation (blocks submission early) ---
                const isBonusChecked = document.getElementById("IsBonusApplicable")?.checked;
                const bonusAmount = document.getElementById("BonusAmount")?.value.trim();

                if (!isBonusChecked && bonusAmount !== "") {
                    await Swal.fire({
                        icon: "error",
                        title: "Validation Error",
                        text: "Bonus amount cannot be filled if 'Is Bonus Applicable' is unchecked!",
                        confirmButtonText: "OK"
                    });
                    return; // stop submission
                }

                if (isBonusChecked && bonusAmount === "") {
                    await Swal.fire({
                        icon: "error",
                        title: "Validation Error",
                        text: "Please enter a Bonus Amount since 'Is Bonus Applicable' is checked!",
                        confirmButtonText: "OK"
                    });
                    return; // stop submission
                }

                // --- HTML5 validity check ---
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }

                // --- Build JSON payload ---
                const formData = new FormData(form);
                const json = {};

                formData.forEach((value, key) => {
                    if (["IsMetro", "OptedNPS", "OptedVPF", "IsBonusApplicable", "IsProbationApplicable"].includes(key)) {
                        json[key] = form[key].checked;
                    } else if (["TotalCTC", "ChosenRFB"].includes(key)) {
                        json[key] = parseFloat(value) || 0;
                    } else if (["BonusAmount"].includes(key)) {
                        json[key] = value?.trim() || "Not Applicable";
                    } else if (key === "DocumentType") {
                        json[key] = parseInt(value);
                    } else {
                        json[key] = value;
                    }
                });

                try {
                    // --- Show loader before preview ---
                    const pdfFrame = document.getElementById("pdfPreviewFrame");
                    const pdfLoader = document.getElementById("pdfLoader");
                    pdfLoader.classList.remove("d-none");
                    pdfFrame.classList.add("d-none");
                    pdfFrame.src = "";

                    // --- Template mapping for modal title ---
                    const templateMap = {
                        1: "Offer Letter (Experienced)",
                        2: "Offer Letter (Fresher)",
                        3: "Appointment Letter (Experienced)",
                        4: "Appointment Letter (Fresher)"
                    };
                    document.getElementById("pdfPreviewModalLabel").innerText =
                        "Preview - " + (templateMap[json.DocumentType] || "Document");

                    // --- Fetch PDF Preview from backend ---
                    const previewResponse = await fetch('/Salary/PreviewSalaryBreakdown', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(json)
                    });

                    if (!previewResponse.ok) throw previewResponse;

                    const pdfBlob = await previewResponse.blob();
                    const pdfUrl = URL.createObjectURL(pdfBlob);
                    pdfFrame.src = pdfUrl;

                    pdfFrame.onload = function () {
                        pdfLoader.classList.add("d-none");
                        pdfFrame.classList.remove("d-none");
                    };

                    // --- Show modal preview ---
                    const modal = new bootstrap.Modal(document.getElementById("pdfPreviewModal"));
                    modal.show();

                    // --- Confirm save ---
                    document.getElementById("confirmPdfBtn").onclick = async function () {
                        try {
                            const submitResponse = await fetch('/Salary/SubmitSalaryBreakdown', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(json)
                            });

                            if (!submitResponse.ok) throw submitResponse;

                            const submitData = await submitResponse.json();

                            Swal.fire({
                                icon: "success",
                                title: "Success",
                                text: submitData.message
                            }).then(() => {
                                modal.hide();
                                window.location.href = '/Salary/CalculateSalaryBreakdown';
                            });
                        } catch (err) {
                            let errorMsg = "Something went wrong";
                            try {
                                const errorData = await err.json();
                                errorMsg = errorData.message || errorMsg;
                            } catch { }
                            Swal.fire({
                                icon: "error",
                                title: "Error",
                                text: errorMsg
                            });
                        }
                    };

                } catch (err) {
                    let errorMsg = "Something went wrong";
                    try {
                        const errorData = await err.json();
                        errorMsg = errorData.message || errorMsg;
                    } catch { }
                    Swal.fire({
                        icon: "error",
                        title: "Error",
                        text: errorMsg
                    });
                }
            });
        </script>


        <script>
            document.addEventListener("DOMContentLoaded", function () {
                const documentTypeDropdown = document.getElementById("documentType");

                documentTypeDropdown.addEventListener("change", function () {
                    const selectedValue = this.value;

                    switch (selectedValue) {
                        case "5": // Offer Letter Intern
                            window.location.href = '@Url.Action("CreateInternOfferLetter", "Employee")';
                            break;

                        case "6": // Relieving & Experience Letter
                            window.location.href = '@Url.Action("CreateRelievingExpLetter", "Employee")';
                            break;

                        default:
                            // Do nothing for other options
                            break;
                    }
                });
            });
        </script>


    


        @{
            await Html.RenderPartialAsync("_ValidationScriptsPartial");
        }

    }

    </body>
</html>

